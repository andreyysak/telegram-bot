import { Bot, Context, session, SessionFlavor } from 'grammy';
import dotenv from 'dotenv';
import pool from './db/client.js';

import { tripModule } from './modules/car/trip.js';
import { tripHistoryModule } from './modules/car/tripHistory.js';
import { weatherModule } from './modules/weather/weather.js';
import { gasModule } from './modules/car/gas.js';

import { contactKeyboard } from './keyboard/shareContact.js';
import { CAR_MENU_TEXT, mainMenuKeyboard } from './keyboard/mainMenu.js';
import { carMenuKeyboard } from './keyboard/carMenu.js';
import { BACK_TO_MAIN_TEXT } from './keyboard/backToMenu.js';
import { SessionData } from './types/SessionData.js';

dotenv.config();

export type BotContext = Context & SessionFlavor<SessionData>;

const token = process.env.TELEGRAM_BOT_TOKEN;

if (!token) throw new Error('Telegram bot token was not found');

const bot = new Bot<BotContext>(token);

// === –°–µ—Å—ñ—è ===
bot.use(
  session({
    initial: (): SessionData => ({
      registered: false,
    }),
  })
);

bot.use(tripModule)
bot.use(tripHistoryModule)
bot.use(weatherModule)
bot.use(gasModule)

// === –ö–æ–º–∞–Ω–¥–∞ /start ===
bot.command('start', async (ctx) => {
  await ctx.reply('–ü—Ä–∏–≤—ñ—Ç! –©–æ–± –ø–æ—á–∞—Ç–∏ —Ä–æ–±–æ—Ç—É, –ø–æ–¥—ñ–ª–∏—Å—å —Å–≤–æ—ó–º –∫–æ–Ω—Ç–∞–∫—Ç–æ–º:', {
    reply_markup: contactKeyboard,
  });
});

// === –û–±—Ä–æ–±–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç—É ===
bot.on(':contact', async (ctx) => {
  const contact = ctx.message?.contact;
  const username = ctx.from?.username;

  if (!contact) {
    return ctx.reply('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç.', {
      reply_markup: { remove_keyboard: true },
    });
  }

  const { phone_number, first_name, last_name, user_id } = contact;

  try {
    // –ó–∞–ø–∏—Å—É—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —É –ë–î
    const res = await pool.query(
      `
      INSERT INTO users 
        (telegram_user_id, username, first_name, last_name, phone_number) 
      VALUES 
        ($1, $2, $3, $4, $5) 
      ON CONFLICT (telegram_user_id) DO NOTHING
      RETURNING *`,
      [user_id, username, first_name, last_name || null, phone_number]
    );

    if (res.rows.length > 0) {
      const user = res.rows[0];
      console.log('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π:', user);
      await ctx.reply('‚úÖ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞!', {
        reply_markup: mainMenuKeyboard,
      });
    } else {
      await ctx.reply(`üëã –ü—Ä–∏–≤—ñ—Ç, ${first_name}!`, {
        reply_markup: mainMenuKeyboard,
      });
    }

    // –ü–æ–∑–Ω–∞—á–∞—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —è–∫ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ–≥–æ
    ctx.session.registered = true;

  } catch (error) {
    console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Ä–æ–±–æ—Ç—ñ –∑ –ë–î:', error);
    await ctx.reply('‚ö†Ô∏è –°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.', {
      reply_markup: { remove_keyboard: true },
    });
  }
});

// === –û–±—Ä–æ–±–∫–∞ –≤—Å—ñ—Ö —ñ–Ω—à–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (–¥–æ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó) ===
bot.on(':text', async (ctx) => {
  const text = ctx.message?.text;

  // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —â–µ –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π
  if (!ctx.session.registered) {
    return ctx.reply('–°–ø–æ—á–∞—Ç–∫—É –ø–æ–¥—ñ–ª–∏—Å—å —Å–≤–æ—ó–º –∫–æ–Ω—Ç–∞–∫—Ç–æ–º.', {
      reply_markup: contactKeyboard,
    });
  }

  // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —É–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π, –æ–±—Ä–æ–±–ª—è—î–º–æ –∫–æ–º–∞–Ω–¥–∏
  if (text === BACK_TO_MAIN_TEXT) {
    return ctx.reply('–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é:', {
      reply_markup: mainMenuKeyboard,
    });
  }

  if (text === CAR_MENU_TEXT) {
    return ctx.reply('üèéÔ∏è –û–±—Ä–∞–Ω–æ –ê–≤—Ç–æ', {
      reply_markup: carMenuKeyboard,
    });
  }

  if (text === BACK_TO_MAIN_TEXT) {
    return ctx.reply('‚¨ÖÔ∏è –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –Ω–∞–∑–∞–¥', {
      reply_markup: mainMenuKeyboard,
    });
  }
});

export default bot