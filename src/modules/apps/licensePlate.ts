import { Composer } from "grammy";
import { BotContext } from "../../bot.js";
import { appsMenuKeyboard, NOMER_ZNAK } from "../../keyboard/appsKeyboard.js";
import { getLicenseCarInfo } from "../../services/licensePlate.js";

export const licensePlate = new Composer<BotContext>()

licensePlate.hears(NOMER_ZNAK, async (ctx) => {
  ctx.session.license_plate = {
    state: 'awaiting_license_plate'
  }

  await ctx.reply('üé´ –í–≤–µ–¥–∏ –Ω–æ–º–µ—Ä–Ω–∏–π –∑–Ω–∞–∫ –∞–≤—Ç–æ: ', {
    reply_markup: appsMenuKeyboard
  })
})

licensePlate.on(':text').filter(
  (ctx): boolean => ctx.session.license_plate?.state === 'awaiting_license_plate',
  async (ctx) => {
    const text = ctx.message?.text

    const nomer_znak = text?.trim().toUpperCase()

    if (!nomer_znak) {
      await ctx.reply("‚ùå –ù–µ –æ—Ç—Ä–∏–º–∞–Ω–æ –Ω–æ–º–µ—Ä–Ω–∏–π –∑–Ω–∞–∫", {
        reply_markup: appsMenuKeyboard
      })

      return
    }

    try {
      const data = await getLicenseCarInfo(nomer_znak)

      const sortedMessage = data
        .sort((a, b) => {
          const textA = a.name.replace(/^[^\p{L}\p{N}]+/u, '').trim();
          const textB = b.name.replace(/^[^\p{L}\p{N}]+/u, '').trim();
          return textA.localeCompare(textB, 'uk');
        })
        .map(item => `${item.name} ${Array.isArray(item.value) ? item.value.join(', ') : item.value}`)
        .join('\n');

      await ctx.reply(sortedMessage);

      ctx.session.license_plate = {
        state: null
      }
    } catch (e) {
      console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –¥–∞–Ω–∏—Ö –ø—Ä–æ IP:', e);
      await ctx.reply('‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ –ø—Ä–æ IP.', {
        reply_markup: appsMenuKeyboard,
      });
    }
  }
)