import { Composer } from "grammy";
import { BotContext } from "../../bot.js";
import { ADD_TEXT, todoKeyboard } from "../../keyboard/todoKeyboard.js";
import { BACK_TO_MAIN_TEXT } from "../../keyboard/backToMenu.js";
import { mainMenuKeyboard } from "../../keyboard/mainMenu.js";
import pool from "../../db/client.js";

export const addTodoModule = new Composer<BotContext>()

addTodoModule.hears(ADD_TEXT, async (ctx) => {
  await ctx.reply('üí¨ –í–≤–µ–¥–∏ –Ω–∞–∑–≤—É:', {
    reply_markup: todoKeyboard
  })

  ctx.session.todo = {
    state: 'add_todo'
  }
})

addTodoModule.hears(BACK_TO_MAIN_TEXT, async (ctx) => {
  await ctx.reply('‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é', {
    reply_markup: mainMenuKeyboard
  })
  
  ctx.session.todo = {
    state: null
  }
})

addTodoModule.on(':text').filter(
  (ctx): boolean => ctx.session.todo?.state === 'add_todo',
  async (ctx) => {
    const title = ctx.message?.text
    const userId = ctx.from?.id

    if (!title) throw new Error('‚ùå –ù–µ –æ—Ç—Ä–∏–º–∞–Ω–æ –∂–æ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö.')
      
    ctx.session.todo = {
      ...ctx.session.todo,
      title: title,
      state: 'add_todo'
    }

    try {
      // –û—Ç—Ä–∏–º—É—î–º–æ user_id —ñ–∑ —Ç–∞–±–ª–∏—Ü—ñ users
      const userRes = await pool.query(
        'SELECT id FROM users WHERE telegram_user_id = $1',
        [userId]
      );

      if (userRes.rows.length === 0) {
        return ctx.reply('‚ùå –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ —É —Å–∏—Å—Ç–µ–º—ñ.');
      }

      const dbUserId = userRes.rows[0].id;

      // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å–ø—Ä–∞–≤—É –≤ –ë–î
      await pool.query(
        'INSERT INTO todos (user_id, text, done, created_at) VALUES ($1, $2, $3, NOW())',
        [dbUserId, title, false]
      );

      await ctx.reply(`‚úÖ –°–ø—Ä–∞–≤—É "${title}" —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ.`, {
        reply_markup: todoKeyboard,
      });

      ctx.session.todo = {
        state: null,
      };

    } catch (e) {
      console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ To-Do:', e);
      await ctx.reply('‚ö†Ô∏è –°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ —Å–ø—Ä–∞–≤–∏.', {
        reply_markup: todoKeyboard,
      });
  }
}
)