import { SalaryService } from './salaryService.js';

const url = process.env.XCITY_URL;

function formatDate(date: Date | null): string {
  if (!date) return '';
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  return `${year}${month}`;
}

export async function getXcityDataForOperator(operatorId: number) {
  const now = new Date();
  const formattedDate = formatDate(now);

  if (!formattedDate || !url) {
    console.error('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –¥–∞—Ç—É –∞–±–æ URL –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.');
    return null;
  }

  try {
    const response = await fetch(`${url}${formattedDate}`);

    if (!response.ok) {
      throw new Error(`‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –¥–∞–Ω–∏—Ö: ${response.status} ${response.statusText}`);
    }

    const raw = await response.json();

    // üîÅ –î–∞–Ω—ñ ‚Äî —Ü–µ –æ–±'—î–∫—Ç, –¥–µ –∫–ª—é—á—ñ ‚Äî people_id
    const operatorKey = String(operatorId); // –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ –≤ —Ä—è–¥–æ–∫, –±–æ JSON –º–∞—î –∫–ª—é—á—ñ —è–∫ —Å—Ç—Ä–æ–∫–∏

    if (!raw[operatorKey]) {
      console.warn(`‚ö†Ô∏è –î–∞–Ω—ñ –¥–ª—è people_id=${operatorId} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ`);
      return null;
    }

    // –§–æ—Ä–º—É—î–º–æ –º–∞—Å–∏–≤ —ñ–∑ –æ–¥–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
    const data = [raw[operatorKey]];

    // –†–∞—Ö—É—î–º–æ —á–µ—Ä–µ–∑ —Ç–≤—ñ–π SalaryService
    const calculatedResults = SalaryService(data);

    return calculatedResults[0]; // –±–µ—Ä–µ–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –æ–¥–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞

  } catch (e) {
    console.error(`‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –¥–∞–Ω–∏—Ö:`, e);
    return null;
  }
}